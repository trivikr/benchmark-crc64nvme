export const table = new Uint32Array([
  0, 0, 2137977032, 808814969, 4275954064, 1617629938, 2175996248, 1348377483,
  3378701683, 2554443407, 3054245307, 2826190838, 935265507, 4163544189,
  1221719083, 3357486340, 2786913460, 1746206325, 3648134268, 1478588172,
  1489046820, 142601351, 665845228, 944399870, 1870531015, 4032121082,
  269547791, 3227566467, 2443438167, 2420005384, 4006418591, 2685129585,
  2028011323, 2294181761, 126750707, 3096176376, 2252152491, 3906305395,
  4183027299, 3638621194, 2978093640, 285202702, 3471633024, 550129783,
  1331690456, 1888799740, 808520464, 1084310149, 3741062031, 3769274868,
  2710758215, 3500087437, 539095583, 2160165638, 1599013591, 2968783487,
  396293884, 2028676987, 1760560692, 1222553090, 3913488236, 411055497,
  2519590820, 682999024, 4056022647, 293396226, 2393837247, 558454395,
  253501415, 1897385456, 1886580527, 1092764809, 950213380, 2302503309,
  1204677580, 3104366836, 3330210452, 3914759039, 3104836188, 3647205894,
  1474106051, 2036867447, 682877451, 1230874638, 2835411795, 419640197,
  3597534107, 691452668, 2663380912, 3777599480, 3788572536, 3508280961,
  1617040928, 2168620298, 520939240, 2977369203, 2300641612, 2579673219,
  4132434308, 2851551738, 2013061340, 4188643953, 143790100, 3382455048,
  1078191167, 25363980, 1059919095, 834047861, 3198027183, 1642599678,
  3253794151, 1373478279, 792587768, 4057353974, 1347624240, 3252930447,
  3521121384, 2445106180, 2928606368, 2710099325, 3864987787, 1771567225,
  2570188867, 1503817984, 411232539, 167570059, 1743526355, 969499634,
  3613055677, 2054040943, 2821991029, 1247519766, 696728365, 436551581,
  1458162661, 707835620, 507002830, 3794770912, 1633079046, 3524924057,
  3773161054, 2185529618, 2676698774, 2993750123, 1900426761, 310039322,
  237553345, 575625827, 2409355161, 1913766376, 4042598225, 1109674129,
  3089421178, 2319148437, 3343524786, 3121540332, 1190736618, 3931141991,
  966246946, 3664117278, 2948212102, 4073734894, 3503609166, 3269839767,
  1365754902, 2461749276, 772355294, 2727270757, 1725481205, 1787950177,
  431370301, 1520729368, 2550473061, 184215187, 3882602925, 986673130,
  161925426, 2596584603, 1992833530, 2867934690, 4152043682, 4205817449,
  2283133034, 3399100176, 3234081857, 42273300, 3215645833, 850428781,
  1041878481, 1659771110, 1098333465, 1390121375, 647701706, 1796403821,
  1509282818, 1529314068, 3628516698, 192536735, 2804430226, 994863590,
  4026122681, 4082320610, 2425827697, 3278294427, 287580201, 2469942800,
  1850396897, 2735595369, 2156382334, 50727960, 4293474486, 859014497,
  2119838190, 1668095722, 20240678, 1398314899, 1239756045, 2605169303,
  915135941, 2876388334, 3073952925, 4214007909, 3361094741, 3407421724,
  1585175537, 3819740652, 555035449, 3550024853, 2695248481, 2210893598,
  3754478249, 3018983015, 2535014018, 2079140707, 3900165706, 1272488474,
  1774509842, 461781393, 380252122, 733196520, 4167513925, 2344117145,
  2265565069, 3146640096, 112907989, 3956502891, 2043946525, 3689347090,
  822465078, 335140118, 1315644158, 600595567, 3487052710, 1938999268,
  2964767598, 1135038109, 2590806825, 2890647989, 3842139105, 2625519820,
  1689350841, 3424705351, 467632753, 4229255742, 1393456730, 873103162,
  744523410, 71300675, 2916325322, 1415671240, 3535628034, 1683285169,
  1014005661, 3294574528, 1126076245, 4100636345, 3266158093, 2754880818,
  3183701701, 2483137611, 4111637230, 1545503055, 2323409446, 1814759478,
  198146942, 1014338493, 1956744118, 205527748, 3800853522, 620078644,
  2648874202, 348139341, 475106690, 1151251654, 1665105226, 1957379519,
  737053025, 3165917371, 1417705897, 2357303746, 3576916209, 3705602633,
  2858260537, 3974794032, 1150320806, 1289836609, 1006530670, 2094321976,
  3125633334, 747260595, 3307442686, 482329546, 2381473237, 3567316686,
  4070348061, 3834996663, 1932493893, 3033267260, 205616269, 2231268677,
  1806527838, 3174504119, 348364182, 2365759438, 2507181262, 3713795141,
  3927866374, 3983117628, 2731509805, 628531256, 3718346981, 356723009,
  1544710589, 1159574218, 595368309, 1965570995, 3450962410, 3575900354,
  3000987938, 3843449275, 862740602, 3041458736, 1275236530, 2239591241,
  80962713, 1298292301, 2076021841, 2102908724, 4195255561, 755584191,
  2237691329, 490522054, 323850853, 898201910, 1814258349, 96268367, 3985667061,
  1440902084, 2466153277, 1708647101, 3660543766, 2915618745, 2772535262,
  2650621632, 619878022, 3450068299, 1536976462, 4254487602, 3042016977,
  1570604867, 3393162777, 1839730234, 1267507009, 1039570353, 887254921,
  230890696, 2083756962, 3319542220, 56453994, 4125735093, 2196666930,
  2780242750, 4253059834, 2508368455, 1295403412, 3592807642, 844675420,
  3859836323, 3018565636, 3058628136, 3431291084, 2256240465, 2220141799,
  1315197525, 4214905903, 2119293740, 2055818615, 772751527, 99073471,
  507169246, 3945440544, 3190889135, 2487506408, 2382664662, 368526512,
  3730442333, 1788458104, 4000284964, 575160403, 644918304, 1562816667,
  373630297, 3700793795, 1176223442, 2751156491, 1982740395, 903263919,
  1587252059, 1253590631, 1856897570, 3406518079, 1055955369, 3026561015,
  247795920, 4239676380, 3336191444, 2212143892, 4142904493, 40481356,
  2796629798, 2097627780, 2525275743, 2479512091, 915371310, 3970214611,
  112917591, 1830271883, 1457809372, 309939011, 1725034149, 1521008488,
  2932786081, 633753504, 2667268824, 2759155448, 3466973523, 3676024368,
  4270872618, 3170351075, 3344514008, 3281602347, 4151095969, 1110070899,
  2805082410, 1027909307, 2533859411, 1972720272, 1595444567, 184263256,
  1865221166, 2336797440, 1064542117, 4096148424, 256251612, 451631959,
  2941109677, 1703259039, 2675461332, 3828792007, 3475429215, 2606254607,
  4279459366, 3549019684, 923562786, 2900840172, 121240155, 760504244,
  1466393040, 1379577724, 1733486761, 3289860312, 1340560473, 3145316368,
  2144525600, 986360136, 797722283, 1168398720, 532271058, 225815979,
  3618038486, 1914396003, 3885198255, 4087893051, 3083726884, 2361834739,
  2281208157, 1644930156, 670280236, 493180068, 398861141, 2631288316,
  1201191134, 3820533044, 2007839143, 2875801887, 3216120995, 3557274071,
  2408027610, 1437900943, 3755544145, 718950471, 4025255720,
]);

/**
 * Alternate implementation in JS using int32 pairs.
 */
export class Crc64Nvme2 {
  constructor() {
    this.reset();
  }

  update(data) {
    let crc1 = this.c1;
    let crc2 = this.c2;
    const len = data.length;

    for (let i = 0; i < len; i++) {
      const idx = ((crc2 ^ data[i]) & 255) << 1;

      crc2 = ((crc2 >>> 8) | ((crc1 & 255) << 24)) >>> 0;
      crc1 >>>= 8;

      crc1 ^= table[idx];
      crc2 ^= table[idx + 1];
    }

    this.c1 = crc1;
    this.c2 = crc2;
  }

  async digest() {
    const c1 = this.c1 ^ 4294967295;
    const c2 = this.c2 ^ 4294967295;

    return new Uint8Array([
      c1 >>> 24,
      (c1 >>> 16) & 255,
      (c1 >>> 8) & 255,
      c1 & 255,
      c2 >>> 24,
      (c2 >>> 16) & 255,
      (c2 >>> 8) & 255,
      c2 & 255,
    ]);
  }

  reset() {
    this.c1 = 4294967295; // int32 max
    this.c2 = 4294967295;
  }
}
